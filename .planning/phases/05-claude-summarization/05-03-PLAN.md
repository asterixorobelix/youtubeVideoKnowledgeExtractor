---
phase: 05-claude-summarization
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - src/hooks/useSummarization.ts
  - src/components/features/CostEstimator.tsx
  - src/components/features/SummaryStatus.tsx
  - src/App.tsx
autonomous: false

must_haves:
  truths:
    - "User sees estimated cost breakdown before processing begins and must confirm"
    - "Each video displays real-time status: queued, estimating, processing, completed, failed"
    - "User can retry individual failed videos without reprocessing successful ones"
    - "Summarize button appears only after transcript extraction completes with at least 1 success"
    - "Processing progress shows X of Y completed with running cost total"
  artifacts:
    - path: "src/hooks/useSummarization.ts"
      provides: "Batch processing hook with useReducer state management"
      exports: ["useSummarization"]
    - path: "src/components/features/CostEstimator.tsx"
      provides: "Pre-processing cost estimation modal/card with confirm button"
      exports: ["CostEstimator"]
    - path: "src/components/features/SummaryStatus.tsx"
      provides: "Per-video summary status indicator"
      exports: ["SummaryStatus"]
    - path: "src/App.tsx"
      provides: "Full integration wiring"
  key_links:
    - from: "src/hooks/useSummarization.ts"
      to: "src/services/summarization.service.ts"
      via: "import summarizeVideo, estimateBatchCost"
      pattern: "import.*summarization\\.service"
    - from: "src/hooks/useSummarization.ts"
      to: "src/services/claude.service.ts"
      via: "import countTranscriptTokens for cost estimation"
      pattern: "import.*claude\\.service"
    - from: "src/App.tsx"
      to: "src/hooks/useSummarization.ts"
      via: "useSummarization hook usage"
      pattern: "useSummarization"
    - from: "src/App.tsx"
      to: "src/components/features/CostEstimator.tsx"
      via: "CostEstimator component rendering"
      pattern: "CostEstimator"
    - from: "src/components/features/SummaryStatus.tsx"
      to: "src/types/summary.ts"
      via: "SummaryResult type for status display"
      pattern: "import.*SummaryResult"

user_setup:
  - service: anthropic
    why: "Claude API summarization requires valid Anthropic API key"
    env_vars: []
    dashboard_config: []
    note: "User-provided API key via existing ApiKeyForm -- no new setup needed. Key already stored in context from Phase 1."
---

<objective>
Build the complete summarization UI flow: a useSummarization hook with useReducer for batch state management, a CostEstimator component that shows estimated costs before processing, a SummaryStatus component for per-video status indicators, and wire everything into App.tsx with retry capability.

Purpose: This is the user-facing integration that ties the Claude API service and summarization logic into a cohesive workflow. The cost estimation step builds trust (requirement PROC-07), the progress tracking satisfies OUT-01, and retry satisfies OUT-03.
Output: Full working summarization flow from cost estimation through processing to results display.
</objective>

<execution_context>
@/Users/nathanstasin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nathanstasin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-claude-summarization/05-RESEARCH.md
@.planning/phases/05-claude-summarization/05-01-SUMMARY.md
@.planning/phases/05-claude-summarization/05-02-SUMMARY.md

@src/App.tsx
@src/hooks/useTranscriptExtraction.ts
@src/types/summary.ts
@src/services/summarization.service.ts
@src/services/claude.service.ts
@src/context/ApiKeysContext.tsx
@src/components/features/TranscriptStatus.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useSummarization hook and UI components</name>
  <files>src/hooks/useSummarization.ts, src/components/features/CostEstimator.tsx, src/components/features/SummaryStatus.tsx</files>
  <action>
**Part A: Create `src/hooks/useSummarization.ts`**

Use `useReducer` pattern from research (Pattern 4). This hook manages the entire summarization lifecycle.

State shape:
```typescript
interface SummarizationState {
  phase: 'idle' | 'estimating' | 'estimated' | 'processing' | 'complete';
  results: Map<string, SummaryResult>;
  costEstimate: BatchCostEstimate | null;
  totalActualCost: number;
  processedCount: number;
}
```

Actions:
```typescript
type SummarizationAction =
  | { type: 'START_ESTIMATE' }
  | { type: 'SET_ESTIMATE'; estimate: BatchCostEstimate }
  | { type: 'ESTIMATE_ERROR'; error: string }
  | { type: 'START_PROCESSING'; videoIds: string[] }
  | { type: 'SET_VIDEO_STATUS'; videoId: string; status: SummaryStatus }
  | { type: 'SET_VIDEO_RESULT'; videoId: string; summary: Summary; cost: number; inputTokens: number; outputTokens: number }
  | { type: 'SET_VIDEO_ERROR'; videoId: string; error: string }
  | { type: 'COMPLETE' }
  | { type: 'RESET' };
```

Hook interface:
```typescript
export function useSummarization(apiKey: string) {
  // Returns:
  return {
    // State
    phase,                    // Current lifecycle phase
    results,                  // Map<string, SummaryResult>
    costEstimate,             // BatchCostEstimate | null
    totalActualCost,          // Running actual cost total
    processedCount,           // How many videos processed so far
    completedCount,           // How many succeeded
    failedCount,              // How many failed

    // Actions
    estimateCost,             // (transcripts: Map<string, string>) => Promise<void>
    startProcessing,          // () => Promise<void> — uses transcripts from estimate phase
    retryVideo,               // (videoId: string, transcript: string) => Promise<void>
    reset,                    // () => void
    getResult,                // (videoId: string) => SummaryResult | undefined
  }
}
```

Implementation details:
1. `estimateCost(transcripts)`: Store transcripts in a ref. Count tokens for each video using `countTranscriptTokens`. Build BatchCostEstimate using `estimateBatchCost`. Dispatch SET_ESTIMATE.
2. `startProcessing()`: Use stored transcripts ref. Process using p-limit (concurrency 3). For each video: dispatch SET_VIDEO_STATUS 'processing', call `summarizeVideo`, dispatch SET_VIDEO_RESULT or SET_VIDEO_ERROR. After all complete, dispatch COMPLETE.
3. `retryVideo(videoId, transcript)`: Set video status to 'processing', call `summarizeVideo`, update result or error. Does NOT affect other video results. Recalculate processedCount.
4. Use `useCallback` for all functions. Pass `apiKey` to service calls.

**Part B: Create `src/components/features/CostEstimator.tsx`**

A card component that displays cost estimation results and a "Proceed" confirmation button.

Props:
```typescript
interface CostEstimatorProps {
  estimate: BatchCostEstimate;
  isProcessing: boolean;
  onConfirm: () => void;
  onCancel: () => void;
}
```

Display:
- Total estimated cost formatted as "$X.XX" (or "$0.00XX" for small amounts)
- Number of videos to process
- Number of videos requiring chunking (if any, with note "X videos are long and will be processed in chunks")
- Per-video average cost
- "Note: Actual cost may vary by up to 10%" disclaimer
- Two buttons: "Cancel" (ghost) and "Proceed ($X.XX)" (primary)
- Use shadcn Card component. Use DollarSign icon from lucide-react.

**Part C: Create `src/components/features/SummaryStatus.tsx`**

Per-video status indicator for the summarization phase. Similar pattern to TranscriptStatus but for summary results.

Props:
```typescript
interface SummaryStatusProps {
  result: SummaryResult | undefined;
}
```

Display states:
- `undefined` or `queued`: Gray clock icon + "Queued"
- `estimating`: Spinner + "Estimating..."
- `processing`: Spinner + "Summarizing..."
- `completed`: Green check icon + "Summary ready"
- `failed`: Red X icon + error message + "Retry" text (retry handled by parent)

Use lucide-react icons (Clock, Loader2, CheckCircle, XCircle). Use Tailwind for colors. Keep component minimal -- just the status indicator, not the full video card.
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. All three files exist and export correctly
3. useSummarization hook compiles with correct typing
  </verify>
  <done>
useSummarization hook manages full lifecycle (idle -> estimating -> estimated -> processing -> complete) with useReducer. CostEstimator shows cost breakdown with confirm/cancel. SummaryStatus displays per-video processing state with icons.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire summarization into App.tsx</name>
  <files>src/App.tsx</files>
  <action>
Integrate the summarization flow into the existing App.tsx. This adds the "Summarize" button, cost estimation display, and per-video summary status.

Changes to `src/App.tsx`:

1. **Import new components and hooks:**
   ```typescript
   import { useSummarization } from '@/hooks/useSummarization'
   import { CostEstimator } from '@/components/features/CostEstimator'
   import { SummaryStatus } from '@/components/features/SummaryStatus'
   ```

2. **Add useSummarization hook in AppContent:**
   ```typescript
   const { keys } = useApiKeys()
   const {
     phase: summaryPhase,
     results: summaryResults,
     costEstimate,
     totalActualCost,
     processedCount,
     completedCount,
     failedCount,
     estimateCost,
     startProcessing,
     retryVideo,
     reset: resetSummary,
     getResult: getSummaryResult,
   } = useSummarization(keys.anthropicKey)
   ```

3. **Add "Summarize" button** (appears after extraction completes with at least 1 success):
   - Condition: `extractionComplete && successCount > 0 && summaryPhase === 'idle'`
   - Check that user has Anthropic key: if `!keys.anthropicKey`, show "Add Anthropic API key in settings to summarize" message instead of button
   - Button text: `Summarize with Claude (${successCount} videos)`
   - onClick: Build transcripts Map from successful TranscriptResults, call `estimateCost(transcripts)`
   - Place this button below the extraction summary area

4. **Show CostEstimator** when `summaryPhase === 'estimated' && costEstimate`:
   ```tsx
   {summaryPhase === 'estimated' && costEstimate && (
     <CostEstimator
       estimate={costEstimate}
       isProcessing={false}
       onConfirm={startProcessing}
       onCancel={resetSummary}
     />
   )}
   ```

5. **Show processing progress** when `summaryPhase === 'processing'`:
   - Display: "Processing... {processedCount} of {totalVideos} complete"
   - Show running cost: "Cost so far: ${totalActualCost.toFixed(4)}"
   - Use Loader2 spinner

6. **Show completion summary** when `summaryPhase === 'complete'`:
   - Display: "{completedCount} summaries ready, {failedCount} failed"
   - If failedCount > 0, note "Click retry on failed videos below"
   - Show total actual cost: "Total cost: ${totalActualCost.toFixed(4)}"

7. **Pass summary results to VideoList** for per-video status display:
   - Add `getSummaryResult` prop to VideoList and VideoCard
   - In VideoCard, show SummaryStatus below TranscriptStatus when summary phase is active
   - Add retry button on failed summary videos that calls `retryVideo(videoId, transcript)`
   - The retry button needs access to the transcript text -- get it from the transcript extraction results

8. **Update VideoList and VideoCard** to accept optional summary props:
   - VideoList: add `getSummaryResult?: (videoId: string) => SummaryResult | undefined` and `onRetrySummary?: (videoId: string) => void`
   - VideoCard: same props, render SummaryStatus and retry button
   - Keep these optional so existing functionality is not broken

9. **Flow summary:**
   - User extracts transcripts (existing)
   - "Summarize with Claude" button appears
   - User clicks -> cost estimation runs
   - CostEstimator card shows with Proceed/Cancel
   - User clicks Proceed -> processing starts
   - Per-video statuses update in real-time
   - Completion summary shows with retry option for failures

IMPORTANT: The Anthropic API key is already managed by ApiKeysContext. Access it via `useApiKeys().keys.anthropicKey`. Do NOT prompt for it again.
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds
3. `npm run dev` starts without errors
4. Visual inspection: after extraction, "Summarize" button appears; clicking shows cost estimate
  </verify>
  <done>
Full summarization flow integrated in App.tsx: Summarize button -> cost estimation -> user confirmation -> batch processing with progress -> completion with retry capability. Per-video summary status visible in video cards.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Claude summarization flow: cost estimation before processing, batch summarization with per-video progress tracking, retry for failed videos, and structured summary output.
  </what-built>
  <how-to-verify>
1. Run `npm run dev` to start the dev server
2. Enter a YouTube channel URL and load videos
3. Select 2-3 videos and extract transcripts
4. After extraction completes, verify "Summarize with Claude" button appears
5. Click the button -- verify cost estimation card appears with dollar amount and video count
6. Click "Proceed" -- verify per-video status updates (queued -> processing -> completed)
7. After completion, verify summary count and total cost are displayed
8. If any videos fail, verify the retry button works
9. Check that the Anthropic API key from settings is used (no additional key prompt)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — no type errors
2. `npm run build` — builds successfully
3. Full user flow works: extract transcripts -> estimate cost -> confirm -> process -> results
4. Per-video status updates in real-time during processing
5. Retry works for failed videos without affecting successful ones
6. Cost estimation shows before processing begins (PROC-07)
7. Structured summaries include title, key_points, topics, notable_quotes (PROC-06)
</verification>

<success_criteria>
- useSummarization hook manages full lifecycle with useReducer
- Cost estimation shown and confirmed before any Claude API calls (PROC-07)
- Structured summaries match SummarySchema (PROC-06)
- Real-time per-video status display (OUT-01)
- Retry for failed videos without reprocessing (OUT-03)
- App compiles and builds cleanly
- Human verification confirms full flow works end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/05-claude-summarization/05-03-SUMMARY.md`
</output>
