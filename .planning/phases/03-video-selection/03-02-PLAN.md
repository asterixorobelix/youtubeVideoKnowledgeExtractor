---
phase: 03-video-selection
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/components/features/SelectionToolbar.tsx
  - src/components/features/VideoList.tsx
  - src/App.tsx
autonomous: true

must_haves:
  truths:
    - "User can select/deselect all loaded videos with one click"
    - "Selection count displays total selected videos"
    - "Select all checkbox shows indeterminate state when some (not all) videos selected"
    - "Selection persists when loading more videos"
    - "Selection clears when a new channel is loaded"
  artifacts:
    - path: "src/components/features/SelectionToolbar.tsx"
      provides: "Toolbar with select all checkbox, count display, and clear button"
      exports: ["SelectionToolbar"]
    - path: "src/components/features/VideoList.tsx"
      provides: "Video list with selection toolbar and per-video selection props"
    - path: "src/App.tsx"
      provides: "App wiring useVideoSelection hook to VideoList"
  key_links:
    - from: "src/App.tsx"
      to: "src/hooks/useVideoSelection.ts"
      via: "useVideoSelection hook called with video IDs"
      pattern: "useVideoSelection"
    - from: "src/App.tsx"
      to: "src/components/features/VideoList.tsx"
      via: "Selection props passed to VideoList"
      pattern: "selectedIds|onToggleSelection|onSelectAll|onClearSelection"
    - from: "src/components/features/VideoList.tsx"
      to: "src/components/features/SelectionToolbar.tsx"
      via: "SelectionToolbar rendered with counts and callbacks"
      pattern: "SelectionToolbar"
    - from: "src/components/features/VideoList.tsx"
      to: "src/components/features/VideoCard.tsx"
      via: "isSelected and onToggleSelection passed to each VideoCard"
      pattern: "isSelected.*onToggleSelection"
---

<objective>
Wire selection controls into the video list: SelectionToolbar with select all/none and count display, VideoList integration, and App-level hook wiring.

Purpose: Complete PROC-02 (select/deselect all) and ensure selection persists across "Load More" operations. This completes Phase 3.
Output: SelectionToolbar component, updated VideoList and App with full selection wiring.
</objective>

<execution_context>
@/Users/nathanstasin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nathanstasin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-video-selection/03-RESEARCH.md
@.planning/phases/03-video-selection/03-01-SUMMARY.md

Key existing files (after Plan 01):
@src/hooks/useVideoSelection.ts — Selection hook with toggle, selectAll, clearSelection
@src/components/features/VideoCard.tsx — Now accepts isSelected + onToggleSelection props
@src/components/features/VideoList.tsx — Currently renders VideoCard without selection
@src/App.tsx — Currently uses useChannelVideos, needs useVideoSelection wiring
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SelectionToolbar component</name>
  <files>
    src/components/features/SelectionToolbar.tsx
  </files>
  <action>
    Create `src/components/features/SelectionToolbar.tsx` with:

    Props interface:
    ```typescript
    interface SelectionToolbarProps {
      selectedCount: number
      totalCount: number
      onSelectAll: () => void
      onClearSelection: () => void
    }
    ```

    Component structure:
    - Outer div: `className="flex items-center justify-between p-3 border rounded-lg bg-muted/50"`
    - Left side (flex items-center gap-3):
      - shadcn/ui Checkbox for "select all":
        - `checked`: true if `selectedCount === totalCount && totalCount > 0`
        - `onCheckedChange`: if all or some selected, call `onClearSelection()`. Otherwise call `onSelectAll()`.
        - For indeterminate state: Radix UI Checkbox supports `checked="indeterminate"` as a prop value. Set `checked` to `"indeterminate"` when `selectedCount > 0 && selectedCount < totalCount`. This is the Radix UI way (NOT the DOM ref approach — Radix handles it natively).
        - `aria-label="Select all videos"`
      - Text span: `className="text-sm font-medium"`:
        - If 0 selected: "Select videos"
        - If some selected: "{selectedCount} of {totalCount} selected"
    - Right side:
      - If `selectedCount > 0`: shadcn/ui Button variant="ghost" size="sm" onClick={onClearSelection}: "Clear selection"

    Return null if `totalCount === 0`.

    Important: Radix UI Checkbox (which shadcn/ui wraps) accepts `checked: boolean | "indeterminate"`. Use this directly instead of the DOM ref approach. This is cleaner and the research's Pattern 3 ref approach is unnecessary for Radix.
  </action>
  <verify>
    - `npx tsc --noEmit` — no type errors
    - Component exports `SelectionToolbar`
  </verify>
  <done>
    SelectionToolbar renders with select all checkbox (tri-state: unchecked/indeterminate/checked), selection count text, and clear button. Returns null when no videos loaded.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire selection into VideoList and App</name>
  <files>
    src/components/features/VideoList.tsx
    src/App.tsx
  </files>
  <action>
    1. Update `src/components/features/VideoList.tsx`:
       - Add new props to VideoListProps:
         ```typescript
         isSelected: (id: string) => boolean
         onToggleSelection: (id: string) => void
         selectedCount: number
         onSelectAll: () => void
         onClearSelection: () => void
         ```
       - Import `SelectionToolbar` from `./SelectionToolbar`
       - Add `SelectionToolbar` between the video count text and the video cards:
         ```tsx
         <SelectionToolbar
           selectedCount={selectedCount}
           totalCount={videos.length}
           onSelectAll={onSelectAll}
           onClearSelection={onClearSelection}
         />
         ```
       - Pass selection props to each `VideoCard`:
         ```tsx
         <VideoCard
           key={video.id}
           video={video}
           isSelected={isSelected(video.id)}
           onToggleSelection={onToggleSelection}
         />
         ```

    2. Update `src/App.tsx`:
       - Import `useVideoSelection` from `@/hooks/useVideoSelection`
       - After `useChannelVideos()`, add:
         ```typescript
         const videoIds = videos.map(v => v.id)
         const {
           isSelected,
           toggleSelection,
           selectAll,
           clearSelection,
           selectionCount,
         } = useVideoSelection(videoIds)
         ```
       - Pass new props to `<VideoList>`:
         ```tsx
         <VideoList
           videos={videos}
           isLoadingMore={isLoadingMore}
           hasMore={nextPageToken !== null}
           onLoadMore={loadMore}
           totalResults={totalResults}
           isSelected={isSelected}
           onToggleSelection={toggleSelection}
           selectedCount={selectionCount}
           onSelectAll={selectAll}
           onClearSelection={clearSelection}
         />
         ```

    3. Handle channel switch: In the `useVideoSelection` hook (created in Plan 01), selection should clear when channel changes. The hook receives `availableVideoIds` — when these change completely (new channel loaded), the existing selection IDs won't match new IDs. Two approaches:
       - Approach A (simpler): Add a `useEffect` in `useVideoSelection` that clears selection when `availableVideoIds` reference changes AND the new IDs don't overlap with current selection. This auto-cleans stale selections.
       - Approach B (explicit): Have App call `clearSelection()` inside `fetchChannel` callback. Since `fetchChannel` resets videos to [], the hook's availableVideoIds will be [] briefly, then new IDs.

       Use Approach A: Add to `useVideoSelection`:
       ```typescript
       // Clear stale selection when video list completely changes (new channel)
       useEffect(() => {
         if (availableVideoIds.length > 0) {
           setSelectedIds(prev => {
             const stillValid = new Set([...prev].filter(id => availableVideoIds.includes(id)));
             if (stillValid.size !== prev.size) {
               return stillValid;
             }
             return prev;
           });
         }
       }, [availableVideoIds]);
       ```
       This prunes any selected IDs not in current video list, handling channel switches gracefully while preserving valid selections during "Load More".
  </action>
  <verify>
    - `npx tsc --noEmit` — no type errors
    - `npx vitest run` — all tests pass (including VideoCard tests from Plan 01)
    - Manual check: App renders SelectionToolbar above video list when videos loaded
  </verify>
  <done>
    VideoList shows SelectionToolbar with select all/none checkbox and count. Each VideoCard has a working checkbox. Selection persists across "Load More". Stale selections are pruned on channel switch. Full selection flow works end-to-end.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npx vitest run` passes (all tests including Plan 01 VideoCard tests)
3. SelectionToolbar renders with correct tri-state checkbox behavior
4. VideoList passes selection props to VideoCard components
5. App.tsx wires useVideoSelection to VideoList
6. Selection count updates in real-time as checkboxes are toggled
7. "Select all" selects all loaded videos, "Clear selection" deselects all
8. Loading more videos preserves existing selections
</verification>

<success_criteria>
- User can select/deselect all videos with one click (PROC-02)
- Selection count displays correctly in toolbar
- Indeterminate checkbox state shows when some (not all) selected
- Selection persists through "Load More" operations
- Stale selections pruned on channel switch
- No TypeScript errors, all tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-video-selection/03-02-SUMMARY.md`
</output>
