---
phase: 03-video-selection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/ui/checkbox.tsx
  - src/hooks/useVideoSelection.ts
  - src/components/features/VideoCard.tsx
  - src/components/features/VideoCard.test.tsx
autonomous: true

must_haves:
  truths:
    - "useVideoSelection hook tracks selected video IDs in Set<string> with O(1) lookup"
    - "Selection state persists to sessionStorage and restores on mount"
    - "VideoCard renders a checkbox that toggles selection state"
    - "Checkbox shows checked state when video is selected"
    - "Checkbox has accessible aria-label with video title"
  artifacts:
    - path: "src/hooks/useVideoSelection.ts"
      provides: "Selection hook with toggle, selectAll, clearSelection, sessionStorage persistence"
      exports: ["useVideoSelection"]
    - path: "src/components/ui/checkbox.tsx"
      provides: "shadcn/ui Checkbox component (Radix UI)"
    - path: "src/components/features/VideoCard.tsx"
      provides: "Video card with selection checkbox"
    - path: "src/components/features/VideoCard.test.tsx"
      provides: "Tests for checkbox rendering and toggle behavior"
  key_links:
    - from: "src/hooks/useVideoSelection.ts"
      to: "sessionStorage"
      via: "useSyncExternalStore for storage sync"
      pattern: "useSyncExternalStore|sessionStorage"
    - from: "src/components/features/VideoCard.tsx"
      to: "src/components/ui/checkbox.tsx"
      via: "Checkbox import and render"
      pattern: "Checkbox.*checked.*onCheckedChange"
---

<objective>
Add video selection capability: a reusable selection hook with sessionStorage persistence and checkbox integration into VideoCard.

Purpose: Enable individual video selection (PROC-01), which is the foundation for batch processing in Phase 4+.
Output: useVideoSelection hook, shadcn/ui Checkbox component, updated VideoCard with checkbox, tests.
</objective>

<execution_context>
@/Users/nathanstasin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nathanstasin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-video-selection/03-RESEARCH.md

Key existing files:
@src/types/youtube.ts — VideoItem has `id: string` field used as selection key
@src/components/features/VideoCard.tsx — Current card without checkbox, to be modified
@src/hooks/useChannelVideos.ts — Pattern reference for hook structure
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install shadcn/ui Checkbox and create useVideoSelection hook</name>
  <files>
    src/components/ui/checkbox.tsx
    src/hooks/useVideoSelection.ts
  </files>
  <action>
    1. Install shadcn/ui Checkbox component:
       ```bash
       npx shadcn@latest add checkbox --yes
       ```
       This creates `src/components/ui/checkbox.tsx` with Radix UI primitives.

    2. Create `src/hooks/useVideoSelection.ts` with:
       - Internal `useSessionStorage<T>(key, initialValue)` helper using `useSyncExternalStore`:
         - `subscribe`: listen to `window` `storage` event
         - `getSnapshot`: read from `sessionStorage.getItem(key)`, JSON.parse, fallback to initialValue
         - `getServerSnapshot`: return initialValue
         - `setValue`: `sessionStorage.setItem(key, JSON.stringify(value))` then dispatch `new Event('storage')`
       - Main `useVideoSelection(availableVideoIds: string[])` hook:
         - State: `useState<Set<string>>(() => new Set(restoredArray))` initialized from sessionStorage
         - Sync: `useEffect` to write `Array.from(selectedIds)` to sessionStorage on change
         - `isSelected(id)`: `selectedIds.has(id)` — O(1) lookup
         - `toggleSelection(id)`: clone Set, add/delete, set state
         - `selectAll()`: `new Set(availableVideoIds)`
         - `clearSelection()`: `new Set()`
         - `getSelectedIds()`: `Array.from(selectedIds)`
         - Return: `{ selectedIds, isSelected, toggleSelection, selectAll, clearSelection, getSelectedIds, selectionCount }`
       - All callbacks wrapped in `useCallback` for referential stability
       - sessionStorage key: `'selected-videos'`
       - Clear selection when availableVideoIds changes to a completely different set (channel switch detection): compare first ID, if different from stored, clear.

    Important: Set is NOT JSON-serializable. Always convert to Array before sessionStorage write, convert back to Set on read.
  </action>
  <verify>
    - `src/components/ui/checkbox.tsx` exists (shadcn/ui generated)
    - `src/hooks/useVideoSelection.ts` exports `useVideoSelection`
    - TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
    useVideoSelection hook exists with Set-based selection, sessionStorage persistence via useSyncExternalStore, and all selection operations (toggle, selectAll, clear). Checkbox UI component installed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add checkbox to VideoCard with tests</name>
  <files>
    src/components/features/VideoCard.tsx
    src/components/features/VideoCard.test.tsx
  </files>
  <action>
    1. Update `src/components/features/VideoCard.tsx`:
       - Add props: `isSelected: boolean`, `onToggleSelection: (id: string) => void`
       - Import `Checkbox` from `@/components/ui/checkbox`
       - Import `Label` from `@/components/ui/label`
       - Add checkbox as first element inside the flex container:
         ```tsx
         <div className="flex items-start pt-1">
           <Checkbox
             id={`video-${video.id}`}
             checked={isSelected}
             onCheckedChange={() => onToggleSelection(video.id)}
             aria-label={`Select ${video.title}`}
           />
         </div>
         ```
       - Change the `<h3>` to a `<Label htmlFor={`video-${video.id}`}>` so clicking the title toggles the checkbox
       - Keep `className` on Label same as current h3: `"font-medium text-sm line-clamp-2 leading-tight cursor-pointer"`

    2. Create `src/components/features/VideoCard.test.tsx`:
       - Import render, screen, fireEvent from `@testing-library/react`
       - Import describe, it, expect, vi from `vitest`
       - Mock video: `{ id: 'v123', title: 'Test Video', thumbnail: 'https://example.com/thumb.jpg', publishedAt: '2026-01-15T00:00:00Z', duration: 'PT10M' }`
       - Test: "renders checkbox unchecked when not selected" — `getByRole('checkbox')`, `expect(checkbox).not.toBeChecked()`
       - Test: "renders checkbox checked when selected" — pass `isSelected={true}`, `expect(checkbox).toBeChecked()`
       - Test: "calls onToggleSelection with video id on click" — fireEvent.click checkbox, expect handler called with `'v123'`
       - Test: "clicking label toggles selection" — fireEvent.click on label text, expect handler called

    Note: Radix UI Checkbox renders `<button role="checkbox">`, so `getByRole('checkbox')` works. The `aria-label` prop provides the accessible name. Use `{ name: /select test video/i }` to query specifically.
  </action>
  <verify>
    - `npx vitest run src/components/features/VideoCard.test.tsx` — all 4 tests pass
    - `npx tsc --noEmit` — no type errors
  </verify>
  <done>
    VideoCard displays checkbox with correct checked/unchecked state, calls onToggleSelection with video ID on click, label is clickable, and all tests pass.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes (no type errors across project)
2. `npx vitest run` passes (VideoCard tests + any existing tests)
3. `src/components/ui/checkbox.tsx` exists
4. `src/hooks/useVideoSelection.ts` exports useVideoSelection with Set-based state
5. VideoCard accepts isSelected and onToggleSelection props
</verification>

<success_criteria>
- useVideoSelection hook provides O(1) selection lookup via Set
- Selection persists to sessionStorage (survives "Load More" re-renders)
- VideoCard renders accessible checkbox with aria-label
- All tests pass
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-video-selection/03-01-SUMMARY.md`
</output>
