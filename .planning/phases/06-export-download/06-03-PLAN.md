---
phase: 06-export-download
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/useSummarization.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Export/Download button appears after summarization completes"
    - "Button shows accurate count of completed summaries"
    - "Summarize button disappears when processing starts"
  artifacts:
    - path: "src/hooks/useSummarization.ts"
      provides: "Summarization state with race-condition-free completion detection"
  key_links:
    - from: "src/hooks/useSummarization.ts"
      to: "src/App.tsx"
      via: "summaryPhase and completedCount values"
      pattern: "summaryPhase === 'complete' && completedCount > 0"
---

<objective>
Fix race condition preventing Export button from appearing after summarization completes

**Purpose:** Resolve blocker UAT gap where Promise.all completion dispatches COMPLETE before all SET_VIDEO_RESULT actions are batched by React, causing completedCount=0 when phase transitions to 'complete'. This prevents the ExportButton from becoming visible (condition: summaryPhase==='complete' && completedCount > 0).

**Output:** Working export button visibility after summarization completes with at least one successful summary.
</objective>

<execution_context>
@/Users/nathanstasin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nathanstasin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-export-download/06-UAT.md
</context>

<tasks>

<task type="auto">
  <name>Fix race condition in summarization completion detection</name>
  <files>src/hooks/useSummarization.ts</files>
  <action>
**Root cause:** In `startProcessing` function, `Promise.all` completes and dispatches `COMPLETE` action before React batches all `SET_VIDEO_RESULT` actions. When reducer processes COMPLETE, it sets `phase: 'complete'` but `completedCount` (derived from `state.results`) is still 0 because state updates are batched.

**Fix approach:** Derive phase='complete' from state instead of explicit dispatch.

**Changes to make:**

1. **Add `totalCount` to state interface and initial state** — set to 0
2. **Set `totalCount` in START_PROCESSING** — `totalCount: action.videoIds.length`
3. **In SET_VIDEO_RESULT case** — after incrementing processedCount, check `newProcessedCount >= state.totalCount`. If true, set `phase: 'complete'`
4. **In SET_VIDEO_ERROR case** — same completion check
5. **Remove COMPLETE action type** from SummarizationAction union
6. **Remove COMPLETE case** from reducer
7. **Remove `dispatch({ type: 'COMPLETE' })` call** from startProcessing function

**Why this fixes the race:** Phase='complete' now transitions in the SAME reducer action that updates the final result, so completedCount and phase are always in sync.
  </action>
  <verify>
1. Run build: `npm run build` should succeed with no type errors
2. Run tests: `npm test` should pass
3. Manual test: Start dev server, complete full flow (channel -> select -> extract -> summarize)
4. Observe: After summarization completes, Export button appears immediately with correct count
  </verify>
  <done>
- Export/Download button appears after summarization with at least one completed summary
- No race condition between phase transition and completedCount calculation
- completedCount > 0 when phase='complete' (guaranteed by derived state logic)
  </done>
</task>

</tasks>

<verification>
1. TypeScript build passes
2. All tests pass (no test changes needed)
3. Manual UAT test #1 passes: Export button appears after summarization completes
4. No console errors during summarization or export
</verification>

<success_criteria>
- Phase='complete' transition happens in same action as final result update
- completedCount and phase are always in sync (no race condition possible)
- Export button becomes visible immediately after last video processes
</success_criteria>

<output>
After completion, create `.planning/phases/06-export-download/06-03-SUMMARY.md`
</output>
