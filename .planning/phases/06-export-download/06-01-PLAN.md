---
phase: 06-export-download
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/services/export.service.ts
  - src/services/__tests__/export.service.test.ts
autonomous: true

must_haves:
  truths:
    - "Markdown output includes video title, link, published date, duration, key points, topics, and notable quotes"
    - "Filenames are sanitized: no forbidden characters, no Windows reserved names, video ID prefix for collision safety"
    - "Zip archive contains one markdown file per completed summary"
    - "Zip triggers browser download with timestamped filename"
  artifacts:
    - path: "src/services/export.service.ts"
      provides: "generateMarkdown, sanitizeFilename, generateFilename, exportSummariesToZip"
      exports: ["generateMarkdown", "sanitizeFilename", "generateFilename", "exportSummariesToZip"]
    - path: "src/services/__tests__/export.service.test.ts"
      provides: "Tests for all export service functions"
      min_lines: 80
  key_links:
    - from: "src/services/export.service.ts"
      to: "jszip"
      via: "import JSZip from 'jszip'"
      pattern: "import JSZip"
    - from: "src/services/export.service.ts"
      to: "file-saver"
      via: "import { saveAs } from 'file-saver'"
      pattern: "saveAs"
---

<objective>
Build the export service with TDD: markdown generation from Summary objects, filename sanitization for cross-platform safety, and zip archive creation with JSZip + file-saver.

Purpose: This is the core data transformation layer for Phase 6 â€” turning structured summaries into downloadable markdown files packaged in a zip archive.
Output: Tested export service with generateMarkdown, sanitizeFilename, generateFilename, and exportSummariesToZip functions.
</objective>

<execution_context>
@/Users/nathanstasin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nathanstasin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-export-download/06-RESEARCH.md
@src/types/summary.ts
@src/types/youtube.ts
</context>

<feature>
  <name>Export Service (Markdown + Filename + Zip)</name>
  <files>src/services/export.service.ts, src/services/__tests__/export.service.test.ts</files>
  <behavior>
    **Before writing any implementation, install dependencies:**
    ```bash
    npm install jszip file-saver
    npm install -D @types/file-saver
    ```

    **generateMarkdown(video: VideoItem, summary: Summary) -> string:**
    - Returns markdown string with `# {summary.title}` heading
    - Includes video link: `**Video:** [{video.title}](https://youtube.com/watch?v={video.id})`
    - Includes published date: `**Published:** {formatted date from video.publishedAt}`
    - Includes duration: `**Duration:** {video.duration}`
    - Includes `## Key Points` section with numbered list from summary.key_points
    - Includes `## Topics Covered` section with bullet list from summary.topics
    - Includes `## Notable Quotes` section with blockquotes from summary.notable_quotes
    - If quote has context, adds `> *Context: {context}*` below the quote
    - Ends with `---\n\n*Generated by YouTube Knowledge Extractor*`

    **sanitizeFilename(input: string) -> string:**
    - Removes Windows forbidden chars: `< > : " / \ | ? *` and control chars (\x00-\x1F)
    - Removes leading dots (hidden files on Unix)
    - Removes trailing spaces and dots (Windows issue)
    - Replaces whitespace with underscores
    - Truncates to 80 chars max
    - Handles Windows reserved names (CON, PRN, AUX, NUL, COM1-9, LPT1-9) by prefixing with underscore
    - Returns 'untitled' for empty/whitespace-only input

    Cases:
    - `"My Video Title"` -> `"My_Video_Title"`
    - `"Video: A <Special> Title?"` -> `"Video_A_Special_Title"`
    - `"CON"` -> `"_CON"`
    - `""` -> `"untitled"`
    - `"..."` -> `"untitled"` (leading dots removed, then trailing dots removed = empty)
    - `"A".repeat(100)` -> first 80 chars
    - `"  spaces  "` -> `"spaces"` (trailing spaces removed)

    **generateFilename(video: VideoItem) -> string:**
    - Returns `{video.id}_{sanitizedTitle}.md`
    - Uses sanitizeFilename on video.title with 80 char limit

    Cases:
    - `{ id: "abc123", title: "My Video" }` -> `"abc123_My_Video.md"`
    - `{ id: "xyz789", title: "CON" }` -> `"xyz789__CON.md"`

    **exportSummariesToZip(summaries: Array<{ video: VideoItem; summary: Summary }>) -> Promise<void>:**
    - Creates JSZip instance
    - Adds one markdown file per summary using generateFilename + generateMarkdown
    - Tracks used filenames to prevent collisions (paranoid safety)
    - Generates zip blob with DEFLATE compression level 6
    - Calls saveAs with filename `youtube-summaries-{YYYY-MM-DD}.zip`
    - Note: This function is hard to unit test due to JSZip/file-saver side effects. Test it by mocking JSZip and saveAs, verifying the correct files are added and saveAs is called with correct filename pattern.
  </behavior>
  <implementation>
    Create `src/services/export.service.ts` with all four functions exported.
    Use `import type` for VideoItem and Summary types.
    Import JSZip as default import, saveAs as named import from file-saver.
    Pure functions (generateMarkdown, sanitizeFilename, generateFilename) are the primary TDD targets.
    For exportSummariesToZip, mock JSZip and file-saver in tests to verify orchestration logic.
  </implementation>
</feature>

<verification>
```bash
npx vitest run src/services/__tests__/export.service.test.ts
npm run build
```
All tests pass. Build succeeds with no type errors.
</verification>

<success_criteria>
- generateMarkdown produces valid markdown with all required sections (title, video link, key points, topics, quotes)
- sanitizeFilename handles all edge cases (forbidden chars, reserved names, empty input, length limit)
- generateFilename produces collision-safe names with video ID prefix
- exportSummariesToZip creates zip with correct files and triggers download
- All tests pass
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/06-export-download/06-01-SUMMARY.md`
</output>
