# Phase 6: Export & Download - Research

**Researched:** 2026-01-31
**Domain:** Browser-based file generation (zip archives, markdown files, programmatic downloads)
**Confidence:** HIGH

## Summary

Phase 6 enables users to download all completed summaries as a single zip file containing individual markdown documents. The research validates that JSZip and file-saver are the industry-standard libraries for client-side zip generation and browser downloads respectively, with excellent cross-browser support. The standard approach creates markdown files from structured summary data (already validated via Zod schemas in Phase 5), sanitizes video titles for safe filenames using video IDs to prevent collisions, packages everything into a zip archive with JSZip, and triggers the download via file-saver's saveAs() function.

Key findings show that blob URL downloads work reliably across Chrome, Firefox, Safari, and Edge (97% browser compatibility score), filename sanitization requires handling cross-platform special characters and reserved names, and markdown generation from structured data is straightforward with template literals. An alternative library, client-zip, offers 40x faster performance than older JSZip versions but lacks compression and extraction capabilities - however, JSZip 3.10+ has closed this gap to only 40% slower while providing mature, battle-tested reliability.

**Primary recommendation:** Use JSZip 3.10+ with file-saver for zip generation and downloads, implement a sanitize-filename-style utility to handle cross-platform filename safety, use video IDs as filename prefixes to guarantee collision-free names, generate markdown files with template literals from Summary type, and create a useExport hook to manage export state and orchestrate the download flow.

## Standard Stack

The established libraries/tools for browser-based zip file generation and downloads:

### Core

| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| jszip | ^3.10.1 | Client-side zip file creation | Industry standard, 17M+ weekly downloads, mature API, works in all browsers |
| file-saver | ^2.0.5 | Trigger browser downloads via saveAs() | De facto standard for programmatic downloads, 7M+ weekly downloads, cross-browser |

### Supporting

| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| sanitize-filename | ^1.6.3 | Cross-platform filename sanitization | Ensuring filenames work on Windows, Mac, Linux |
| @types/file-saver | Latest | TypeScript types for file-saver | TypeScript projects (this project) |

### Alternatives Considered

| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| JSZip | client-zip | client-zip is 40% faster, smaller (2.6kB gzipped), but no compression, no extraction, no encrypted zips |
| file-saver | Manual blob URL + anchor click | file-saver handles edge cases (Safari, Firefox quirks, iOS, memory cleanup) |
| sanitize-filename | Custom regex | Library handles Windows reserved names, length limits, hidden files, trailing dots/spaces |
| JSZip | Manual zip generation | ZIP spec is complex (CRC-32, compression, directory structures, encoding) |

**Installation:**
```bash
npm install jszip file-saver
npm install -D @types/file-saver
```

## Architecture Patterns

### Recommended Project Structure

```
src/
├── services/
│   ├── export.service.ts       # Markdown generation, zip creation
│   └── filename.service.ts     # Sanitization, collision prevention
├── hooks/
│   └── useExport.ts            # Export state management
├── types/
│   └── export.ts               # Export types (ExportStatus, ExportResult)
└── components/
    └── features/
        └── ExportButton.tsx    # Download trigger UI
```

### Pattern 1: Markdown Generation from Structured Data

**What:** Transform Summary objects into markdown text with video metadata
**When to use:** All summary exports
**Example:**
```typescript
// Source: Project requirement OUT-04
import type { Summary } from '@/types/summary';
import type { VideoItem } from '@/types/youtube';

function generateMarkdown(
  video: VideoItem,
  summary: Summary
): string {
  return `# ${summary.title}

**Video:** [${video.title}](https://youtube.com/watch?v=${video.id})
**Published:** ${new Date(video.publishedAt).toLocaleDateString()}
**Duration:** ${video.duration}

## Key Points

${summary.key_points.map((point, i) => `${i + 1}. ${point}`).join('\n')}

## Topics Covered

${summary.topics.map(topic => `- ${topic}`).join('\n')}

## Notable Quotes

${summary.notable_quotes.map(quote => {
  const text = `> ${quote.text}`;
  return quote.context ? `${text}\n>\n> *Context: ${quote.context}*` : text;
}).join('\n\n')}

---

*Generated by YouTube Knowledge Extractor*
`;
}
```

### Pattern 2: Collision-Safe Filename Generation

**What:** Sanitize video titles and prefix with video ID to guarantee uniqueness
**When to use:** All file naming in zip archive
**Example:**
```typescript
// Source: Based on sanitize-filename + YouTube video ID best practices
function sanitizeFilename(input: string, maxLength: number = 100): string {
  // Remove/replace invalid characters
  let sanitized = input
    .replace(/[<>:"/\\|?*\x00-\x1F]/g, '') // Windows forbidden chars
    .replace(/^\.+/, '') // No leading dots (hidden files)
    .replace(/[\s.]+$/, '') // No trailing spaces or dots
    .replace(/\s+/g, '_'); // Replace spaces with underscores

  // Truncate to max length
  if (sanitized.length > maxLength) {
    sanitized = sanitized.substring(0, maxLength);
  }

  // Handle reserved names (Windows)
  const reserved = /^(con|prn|aux|nul|com[0-9]|lpt[0-9])$/i;
  if (reserved.test(sanitized)) {
    sanitized = `_${sanitized}`;
  }

  // Fallback for empty result
  return sanitized || 'untitled';
}

function generateFilename(video: VideoItem): string {
  const sanitizedTitle = sanitizeFilename(video.title, 80);
  return `${video.id}_${sanitizedTitle}.md`; // Video ID prefix prevents collisions
}
```

### Pattern 3: Zip Creation with JSZip

**What:** Create zip archive with multiple markdown files
**When to use:** Exporting multiple summaries
**Example:**
```typescript
// Source: https://github.com/Stuk/jszip
import JSZip from 'jszip';
import { saveAs } from 'file-saver';

async function exportSummaries(
  summaries: Array<{ video: VideoItem; summary: Summary }>
): Promise<void> {
  const zip = new JSZip();

  // Add each summary as markdown file
  summaries.forEach(({ video, summary }) => {
    const markdown = generateMarkdown(video, summary);
    const filename = generateFilename(video);
    zip.file(filename, markdown);
  });

  // Generate zip blob
  const blob = await zip.generateAsync({
    type: 'blob',
    compression: 'DEFLATE', // Standard compression
    compressionOptions: { level: 6 } // Balanced compression level
  });

  // Trigger download
  const timestamp = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
  saveAs(blob, `youtube-summaries-${timestamp}.zip`);
}
```

### Pattern 4: Export Hook with State Management

**What:** React hook to manage export process with loading/error states
**When to use:** Triggering exports from UI
**Example:**
```typescript
// Source: React best practices + Phase 5 useSummarization pattern
import { useState, useCallback } from 'react';
import type { VideoItem } from '@/types/youtube';
import type { SummaryResult } from '@/types/summary';

type ExportStatus = 'idle' | 'generating' | 'success' | 'error';

export function useExport() {
  const [status, setStatus] = useState<ExportStatus>('idle');
  const [error, setError] = useState<string | null>(null);

  const exportSummaries = useCallback(async (
    videos: VideoItem[],
    summaryResults: Map<string, SummaryResult>
  ) => {
    setStatus('generating');
    setError(null);

    try {
      // Filter to only completed summaries
      const completedSummaries = videos
        .map(video => ({
          video,
          summary: summaryResults.get(video.id)?.summary
        }))
        .filter((item): item is { video: VideoItem; summary: Summary } =>
          item.summary !== undefined
        );

      if (completedSummaries.length === 0) {
        throw new Error('No completed summaries to export');
      }

      await exportSummaries(completedSummaries);

      setStatus('success');

      // Reset to idle after brief success state
      setTimeout(() => setStatus('idle'), 2000);
    } catch (err) {
      const errorMessage = err instanceof Error ? err.message : 'Export failed';
      setError(errorMessage);
      setStatus('error');
    }
  }, []);

  const reset = useCallback(() => {
    setStatus('idle');
    setError(null);
  }, []);

  return {
    status,
    error,
    isGenerating: status === 'generating',
    exportSummaries,
    reset
  };
}
```

### Pattern 5: Download Button Component

**What:** UI component to trigger export with visual feedback
**When to use:** Phase 6 export interface
**Example:**
```typescript
// Source: shadcn/ui Button + Lucide icons pattern
import { Button } from '@/components/ui/button';
import { Download, Loader2, CheckCircle } from 'lucide-react';

interface ExportButtonProps {
  onExport: () => void;
  isGenerating: boolean;
  isSuccess: boolean;
  completedCount: number;
  disabled?: boolean;
}

export function ExportButton({
  onExport,
  isGenerating,
  isSuccess,
  completedCount,
  disabled
}: ExportButtonProps) {
  return (
    <Button
      onClick={onExport}
      disabled={disabled || isGenerating || completedCount === 0}
      size="lg"
    >
      {isGenerating ? (
        <>
          <Loader2 className="h-4 w-4 mr-2 animate-spin" />
          Generating zip...
        </>
      ) : isSuccess ? (
        <>
          <CheckCircle className="h-4 w-4 mr-2" />
          Downloaded!
        </>
      ) : (
        <>
          <Download className="h-4 w-4 mr-2" />
          Download Summaries ({completedCount})
        </>
      )}
    </Button>
  );
}
```

### Anti-Patterns to Avoid

- **Don't generate zip on server-side:** Client-side generation reduces server costs, leverages user's CPU, and keeps user data private
- **Don't use video titles alone as filenames:** Collisions are possible (same title, special chars); always prefix with video ID
- **Don't skip filename sanitization:** Windows reserved names (CON, PRN, AUX), forbidden characters, and path traversal vulnerabilities exist
- **Don't forget blob cleanup:** Call `URL.revokeObjectURL()` after downloads if manually creating blob URLs (file-saver handles this)
- **Don't block UI during zip generation:** Use async/await and loading states; large exports can take seconds

## Don't Hand-Roll

Problems that look simple but have existing solutions:

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Zip file creation | Manual ZIP spec implementation | JSZip | ZIP format has CRC-32 checksums, compression algorithms, directory structures, encoding edge cases |
| Browser download | Custom blob URL anchor creation | file-saver | Handles Safari quirks (opens instead of downloads), iOS limitations, Firefox behavior, memory cleanup |
| Filename sanitization | Simple regex replacement | sanitize-filename pattern | Windows reserved names (CON, PRN, COM1-9, LPT1-9), max length (255), trailing dots, hidden files |
| Markdown escaping | Manual string replacement | Template literals with careful escaping | User-generated content (quotes) may contain markdown syntax needing escape |
| Collision detection | Manual tracking of used names | Video ID prefix | YouTube video IDs are globally unique (11 chars, base64), guaranteed collision-free |

**Key insight:** Client-side file operations are deceptively complex due to cross-browser inconsistencies, OS filename requirements, and binary format specifications. Established libraries handle years of edge case discovery.

## Common Pitfalls

### Pitfall 1: Safari Opens ZIP Instead of Downloading

**What goes wrong:** Safari may open the zip file in a new tab instead of triggering a download
**Why it happens:** Safari's default behavior for certain blob types; user settings
**How to avoid:** Use file-saver which handles Safari-specific workarounds; instruct users to use ⌘+S if opened
**Warning signs:** Users on Mac report "file opens but doesn't download"

### Pitfall 2: Windows Filename Forbidden Characters

**What goes wrong:** Files fail to extract on Windows with "invalid filename" errors
**Why it happens:** Windows forbids `< > : " / \ | ? *` and control characters in filenames
**How to avoid:** Sanitize all filenames with regex `/[<>:"/\\|?*\x00-\x1F]/g`
**Warning signs:** Windows users can't extract zip; Mac/Linux users have no issues

### Pitfall 3: Reserved Filename Collisions (Windows)

**What goes wrong:** Windows treats filenames like `CON.md`, `PRN.md`, `AUX.md` as device names, not files
**Why it happens:** Legacy MS-DOS reserved names still honored by Windows
**How to avoid:** Check filename against reserved list, prefix with underscore if match
**Warning signs:** File appears to save but disappears; Windows shows cryptic errors

### Pitfall 4: Large Zip Memory Consumption

**What goes wrong:** Browser crashes or becomes unresponsive when generating very large zips
**Why it happens:** JSZip loads entire zip into memory; 100+ large markdown files can exceed limits
**How to avoid:** Show warning for 50+ summaries; consider pagination/splitting into multiple zips
**Warning signs:** Browser freezes during generation; mobile devices crash

### Pitfall 5: Special Characters in Video Titles

**What goes wrong:** Filenames contain emoji, non-ASCII characters causing extraction issues
**Why it happens:** YouTube video titles can contain any Unicode; not all OS/extractors support Unicode filenames
**How to avoid:** Either strip non-ASCII (`/[^\x00-\x7F]/g`) or ensure UTF-8 encoding in zip options
**Warning signs:** Filenames show as garbled text or `???` on some systems

### Pitfall 6: Markdown Quote Formatting Edge Cases

**What goes wrong:** User quotes containing markdown syntax (e.g., `# Header` in quote) break formatting
**Why it happens:** Template literals don't escape markdown special characters
**How to avoid:** Wrap quotes in blockquotes (`> `) which naturally escapes markdown; test with real YouTube transcripts
**Warning signs:** Exported markdown renders incorrectly when viewed

### Pitfall 7: No User Feedback During Generation

**What goes wrong:** User clicks download, nothing visible happens for 3-10 seconds, user clicks again multiple times
**Why it happens:** Zip generation is CPU-intensive; no loading state shown
**How to avoid:** Show immediate loading spinner, disable button during generation, show success state
**Warning signs:** User reports "clicked 5 times before it worked"

## Code Examples

Verified patterns from official sources:

### Complete Export Service

```typescript
// Source: JSZip documentation + Phase 5 Summary types
import JSZip from 'jszip';
import { saveAs } from 'file-saver';
import type { Summary } from '@/types/summary';
import type { VideoItem } from '@/types/youtube';

function sanitizeFilename(input: string): string {
  return input
    .replace(/[<>:"/\\|?*\x00-\x1F]/g, '')
    .replace(/^\.+/, '')
    .replace(/[\s.]+$/, '')
    .replace(/\s+/g, '_')
    .substring(0, 80) || 'untitled';
}

function generateMarkdown(video: VideoItem, summary: Summary): string {
  return `# ${summary.title}

**Video:** [${video.title}](https://youtube.com/watch?v=${video.id})
**Published:** ${new Date(video.publishedAt).toLocaleDateString()}
**Duration:** ${video.duration}

## Key Points

${summary.key_points.map((point, i) => `${i + 1}. ${point}`).join('\n')}

## Topics Covered

${summary.topics.map(topic => `- ${topic}`).join('\n')}

## Notable Quotes

${summary.notable_quotes.map(quote => {
  const text = `> ${quote.text}`;
  return quote.context ? `${text}\n>\n> *Context: ${quote.context}*` : text;
}).join('\n\n')}

---

*Generated by YouTube Knowledge Extractor*
`;
}

export async function exportSummariesToZip(
  summaries: Array<{ video: VideoItem; summary: Summary }>
): Promise<void> {
  const zip = new JSZip();

  // Track used filenames to prevent collisions (paranoid safety)
  const usedFilenames = new Set<string>();

  summaries.forEach(({ video, summary }) => {
    const sanitizedTitle = sanitizeFilename(video.title);
    let filename = `${video.id}_${sanitizedTitle}.md`;

    // Handle unlikely collision (video ID guarantees uniqueness, but paranoid check)
    let counter = 1;
    while (usedFilenames.has(filename)) {
      filename = `${video.id}_${sanitizedTitle}_${counter}.md`;
      counter++;
    }
    usedFilenames.add(filename);

    const markdown = generateMarkdown(video, summary);
    zip.file(filename, markdown);
  });

  // Generate with compression
  const blob = await zip.generateAsync({
    type: 'blob',
    compression: 'DEFLATE',
    compressionOptions: { level: 6 }
  });

  // Trigger download with timestamp
  const timestamp = new Date().toISOString().split('T')[0];
  saveAs(blob, `youtube-summaries-${timestamp}.zip`);
}
```

### Integration into App.tsx

```typescript
// Source: Current App.tsx pattern
import { useExport } from '@/hooks/useExport';
import { ExportButton } from '@/components/features/ExportButton';

function AppContent() {
  // Existing hooks...
  const { videos } = useChannelVideos();
  const { results: summaryResults } = useSummarization(keys.anthropicKey);

  // New export hook
  const {
    status: exportStatus,
    error: exportError,
    isGenerating,
    exportSummaries
  } = useExport();

  const handleExport = () => {
    exportSummaries(videos, summaryResults);
  };

  // Show export button when summaries are complete
  return (
    <>
      {/* ... existing UI ... */}

      {summaryPhase === 'complete' && completedCount > 0 && (
        <div className="flex justify-center">
          <ExportButton
            onExport={handleExport}
            isGenerating={isGenerating}
            isSuccess={exportStatus === 'success'}
            completedCount={completedCount}
          />
        </div>
      )}

      {exportError && (
        <div className="p-4 rounded-lg border bg-red-50 dark:bg-red-950/20 border-red-200 dark:border-red-800 text-center">
          <p className="text-sm text-red-900 dark:text-red-100">
            Export failed: {exportError}
          </p>
        </div>
      )}
    </>
  );
}
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Server-side zip generation | Client-side with JSZip | ~2015 | Reduced server costs, improved privacy, faster for users |
| Manual anchor + blob URL | file-saver library | ~2016 | Handles Safari/Firefox quirks, iOS support |
| Base64 encoding for download | Blob API | HTML5 (~2014) | Better memory efficiency, supports large files |
| Manual filename sanitization | Standardized patterns (sanitize-filename) | ~2017 | Handles cross-platform edge cases reliably |
| JSZip 2.x (slow) | JSZip 3.10+ (fast) | 2021 | 40x performance improvement, modern API |

**Deprecated/outdated:**
- **download.js:** Older library predating file-saver; less maintained
- **JSZip 2.x:** Significantly slower; use 3.10+ for modern performance
- **Synchronous zip generation:** JSZip 3+ uses async for non-blocking UI

## Revenue Considerations

**Phase revenue impact:** Neutral - Nice-to-have feature that improves retention but not on critical path to first revenue

**Speed to revenue tradeoffs:**

| Decision | Fast Option | "Right" Option | Recommendation | Rationale |
|----------|-------------|----------------|----------------|-----------|
| Export format | Single markdown file (all summaries concatenated) | Zip of individual markdown files | Zip of individual files | Minimal extra complexity, better UX, easier to browse |
| Filename strategy | Video title only | Video ID + sanitized title | Video ID + sanitized title | Prevents collisions, minimal complexity increase |
| Compression | Store only (no compression) | DEFLATE compression | DEFLATE level 6 | Negligible CPU cost, 50-70% file size reduction |
| Export validation | Assume all summaries valid | Validate before export | Filter to completed only | Single filter operation, prevents errors |
| Large export handling | Support unlimited | Warn at 50+ summaries | Support unlimited with warning | Simple warning adds safety, no blocking |

**Monetization architecture notes:**
- Client-side export keeps user data private (selling point for premium tiers)
- Could add "bulk export API" as premium feature for programmatic access
- Export feature increases perceived value (complete workflow) without increasing server costs
- No additional infrastructure required - purely client-side

## Open Questions

Things that couldn't be fully resolved:

1. **Optimal export format alternatives**
   - What we know: Markdown is requirement OUT-04; zip is requirement OUT-02
   - What's unclear: Whether users would also want JSON export for programmatic use
   - Recommendation: Ship markdown-only for MVP; consider JSON export based on user feedback

2. **Large export performance limits**
   - What we know: JSZip loads entire zip in memory; browsers have memory limits
   - What's unclear: Practical limit before browser performance degrades (varies by device)
   - Recommendation: Test with 100 summaries; add warning if >50; consider streaming zips if needed later

3. **Character encoding for international video titles**
   - What we know: YouTube supports full Unicode in titles; zip spec supports UTF-8
   - What's unclear: Whether all extractors (Windows, Mac, Linux) handle UTF-8 filenames consistently
   - Recommendation: Use UTF-8 encoding in JSZip options; test with non-ASCII titles; document known issues if found

4. **Safari download behavior consistency**
   - What we know: file-saver handles Safari quirks; some versions may still open instead of download
   - What's unclear: Current Safari 17/18 (2026) behavior; iOS Safari limitations
   - Recommendation: Use file-saver; test on Safari/iOS; document workaround (⌘+S) if needed

## Sources

### Primary (HIGH confidence)

- [JSZip GitHub Repository](https://github.com/Stuk/jszip) - Official library, API examples, browser compatibility
- [JSZip Documentation](https://stuk.github.io/jszip/documentation/examples.html) - Usage examples, API reference
- [file-saver npm package](https://www.npmjs.com/package/file-saver) - Installation, API, browser support
- [file-saver GitHub Repository](https://github.com/eligrey/FileSaver.js) - Implementation details, edge cases
- [Blob URLs Browser Compatibility (Can I Use)](https://caniuse.com/bloburls) - 97% compatibility score, browser version support

### Secondary (MEDIUM confidence)

- [client-zip GitHub Repository](https://github.com/Touffy/client-zip) - Performance comparison, alternative library evaluation
- [sanitize-filename npm package](https://www.npmjs.com/package/sanitize-filename) - Cross-platform sanitization patterns
- [LogRocket: Programmatically downloading files in the browser](https://blog.logrocket.com/programmatically-downloading-files-browser/) - Browser download best practices (2026)
- [npm-compare: JSZip vs client-zip vs alternatives](https://npm-compare.com/adm-zip,client-zip,jszip,zip-local) - Library comparison, performance benchmarks
- [YouTube video ID structure](https://dev.to/muhammadsaim/discover-the-magic-behind-youtubes-unique-video-ids-21ll) - Video ID uniqueness guarantees

### Tertiary (LOW confidence)

- [WebSearch: React hook download best practices](https://blog.filestack.com/the-ultimate-guide-to-file-downloads-in-react-using-apis/) - General patterns (WebSearch only)
- [WebSearch: Markdown documentation guide](https://developers-toolkit.com/blog/markdown-documentation-guide) - Formatting best practices (WebSearch only)

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - JSZip and file-saver are industry standard, verified via npm stats and official docs
- Architecture: HIGH - Patterns verified via official documentation, aligned with existing Phase 5 patterns
- Pitfalls: MEDIUM - Inferred from library documentation and cross-platform development experience
- Revenue impact: HIGH - Clear non-critical path, minimal complexity, no server costs

**Research date:** 2026-01-31
**Valid until:** 60 days (2026-04-01) — Libraries stable, patterns well-established
