---
phase: 04-transcript-extraction
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/services/transcript.service.ts
  - src/types/transcript.ts
  - src/services/__tests__/transcript.service.test.ts
autonomous: true

must_haves:
  truths:
    - "TranscriptService fetches transcripts from the proxy endpoint"
    - "TranscriptService limits concurrent requests to 5"
    - "TranscriptService returns structured results with success/failure per video"
    - "Failed extractions include specific error messages"
  artifacts:
    - path: "src/types/transcript.ts"
      provides: "TranscriptResult type and related interfaces"
      exports: ["TranscriptResult", "TranscriptStatus"]
    - path: "src/services/transcript.service.ts"
      provides: "Client-side transcript fetching service with concurrency control"
      exports: ["TranscriptService", "fetchTranscripts"]
    - path: "src/services/__tests__/transcript.service.test.ts"
      provides: "Tests for transcript service"
      min_lines: 50
  key_links:
    - from: "src/services/transcript.service.ts"
      to: "/api/transcripts"
      via: "fetch call to proxy endpoint"
      pattern: "fetch.*api/transcripts"
    - from: "src/services/transcript.service.ts"
      to: "p-limit"
      via: "concurrency control import"
      pattern: "pLimit|p-limit"
---

<objective>
Build the client-side TranscriptService that fetches transcripts from the Edge Function proxy with concurrency control and structured error handling, using TDD.

Purpose: The client needs a service layer that manages parallel transcript fetching for multiple selected videos, limiting concurrency to 5 to avoid overwhelming YouTube, and returning per-video success/failure results.
Output: Tested TranscriptService with types, ready for UI integration in Plan 03.
</objective>

<execution_context>
@/Users/nathanstasin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nathanstasin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-transcript-extraction/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create transcript types</name>
  <files>src/types/transcript.ts</files>
  <action>
    Create `src/types/transcript.ts` with:

    ```typescript
    export type TranscriptStatus = 'pending' | 'fetching' | 'success' | 'error';

    export interface TranscriptResult {
      videoId: string;
      status: TranscriptStatus;
      transcript?: string;     // Full joined transcript text
      error?: string;          // Error message if failed
    }
    ```

    Use `import type` convention consistent with existing codebase (see src/types/youtube.ts pattern).
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>TranscriptResult and TranscriptStatus types exported from src/types/transcript.ts</done>
</task>

<task type="auto">
  <name>Task 2: TDD TranscriptService — RED then GREEN</name>
  <files>src/services/__tests__/transcript.service.test.ts, src/services/transcript.service.ts</files>
  <action>
    Install p-limit: `npm install p-limit`

    Create `src/services/` directory if it doesn't exist.

    **RED phase — Write failing tests first** in `src/services/__tests__/transcript.service.test.ts`:

    Test cases to write:
    1. `fetchTranscripts returns success result with transcript text for valid video` — Mock fetch to return `{ videoId, success: true, transcript: 'hello world' }`, verify result has status 'success' and transcript text
    2. `fetchTranscripts returns error result for video without captions` — Mock fetch to return 404 with `{ videoId, success: false, error: 'No captions available' }`, verify result has status 'error' and error message
    3. `fetchTranscripts handles network errors gracefully` — Mock fetch to throw, verify result has status 'error' with 'Network error' message
    4. `fetchTranscripts processes multiple videos and returns results for each` — Mock fetch for 3 videos, verify 3 results returned with correct videoIds
    5. `fetchTranscripts limits concurrency to 5` — Pass 10 videoIds, mock fetch with delay, verify max 5 concurrent calls (use a counter incremented on call start, decremented on call end)
    6. `fetchTranscripts calls correct proxy URL with videoId` — Verify fetch called with `/api/transcripts?videoId=XXX&lang=en`

    Use `vi.fn()` and `vi.stubGlobal('fetch', mockFetch)` for mocking.
    Use `afterEach(() => vi.restoreAllMocks())`.

    Run tests: `npm test` — all should FAIL (RED).

    **GREEN phase — Implement TranscriptService** in `src/services/transcript.service.ts`:

    ```typescript
    import pLimit from 'p-limit';
    import type { TranscriptResult } from '@/types/transcript';

    const CONCURRENT_LIMIT = 5;
    const PROXY_BASE = '/api/transcripts';

    export async function fetchTranscripts(
      videoIds: string[],
      lang: string = 'en'
    ): Promise<TranscriptResult[]> {
      const limit = pLimit(CONCURRENT_LIMIT);

      const tasks = videoIds.map((videoId) =>
        limit(() => fetchSingleTranscript(videoId, lang))
      );

      return Promise.all(tasks);
    }

    async function fetchSingleTranscript(
      videoId: string,
      lang: string
    ): Promise<TranscriptResult> {
      try {
        const response = await fetch(
          `${PROXY_BASE}?videoId=${encodeURIComponent(videoId)}&lang=${encodeURIComponent(lang)}`
        );
        const data = await response.json();

        if (response.ok && data.success) {
          return { videoId, status: 'success', transcript: data.transcript };
        }
        return { videoId, status: 'error', error: data.error || 'Failed to extract captions' };
      } catch {
        return { videoId, status: 'error', error: 'Network error' };
      }
    }
    ```

    Run tests: `npm test` — all should PASS (GREEN).
  </action>
  <verify>`npm test` passes with all 6 test cases green</verify>
  <done>
    TranscriptService exported from src/services/transcript.service.ts with:
    - fetchTranscripts(videoIds, lang) returning TranscriptResult[] via Promise
    - Concurrency limited to 5 via p-limit
    - Per-video error handling (no captions, network errors)
    - Correct proxy URL construction
    - All tests passing
  </done>
</task>

</tasks>

<verification>
- `npm test` passes with all transcript service tests green
- TranscriptResult type exists in src/types/transcript.ts
- fetchTranscripts function handles success, no-captions, and network errors
- Concurrency control verified by test
- No regressions in existing tests
</verification>

<success_criteria>
- Types created and exported
- TranscriptService implemented with TDD (tests written first)
- All 6+ test cases passing
- p-limit installed and used for concurrency control
- Existing tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-transcript-extraction/04-02-SUMMARY.md`
</output>
