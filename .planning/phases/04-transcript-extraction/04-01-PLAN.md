---
phase: 04-transcript-extraction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - api/transcripts.ts
  - vercel.json
autonomous: true

must_haves:
  truths:
    - "Edge Function accepts videoId parameter and returns transcript JSON"
    - "Edge Function returns 404 with error message for videos without captions"
    - "Edge Function returns 400 for missing videoId parameter"
  artifacts:
    - path: "api/transcripts.ts"
      provides: "Vercel Edge Function proxy for YouTube caption extraction"
      exports: ["default handler", "config"]
    - path: "vercel.json"
      provides: "Vercel configuration for Edge Function + SPA routing"
      contains: "rewrites"
  key_links:
    - from: "api/transcripts.ts"
      to: "youtube-caption-extractor"
      via: "getSubtitles import"
      pattern: "getSubtitles"
---

<objective>
Deploy a Vercel Edge Function that proxies YouTube caption extraction, bypassing CORS restrictions.

Purpose: YouTube caption URLs lack CORS headers, so browser-based apps cannot fetch captions directly. This Edge Function acts as a server-side proxy that the client-side TranscriptService will call.
Output: A working `/api/transcripts?videoId=XXX` endpoint that returns transcript text or error responses.
</objective>

<execution_context>
@/Users/nathanstasin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nathanstasin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-transcript-extraction/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install youtube-caption-extractor and create Edge Function</name>
  <files>api/transcripts.ts, vercel.json, package.json</files>
  <action>
    1. Install youtube-caption-extractor: `npm install youtube-caption-extractor`

    2. Create `api/transcripts.ts` â€” a Vercel Edge Function (NOT a Next.js route, this is a Vite project using Vercel's `/api` directory convention):

    ```typescript
    import { getSubtitles } from 'youtube-caption-extractor';

    export const config = { runtime: 'edge' };

    export default async function handler(request: Request) {
      // Parse videoId and optional lang from query params
      // Validate videoId present (return 400 if missing)
      // Call getSubtitles({ videoID: videoId, lang })
      // Join subtitle text segments into single transcript string
      // Return JSON: { videoId, success: true, transcript }
      // On error: return 404 JSON: { videoId, success: false, error: 'No captions available' }
      // Add CORS headers (Access-Control-Allow-Origin: *) for local dev
    }
    ```

    Key implementation details:
    - Accept `videoId` (required) and `lang` (optional, default 'en') query params
    - Join subtitles with space: `subtitles.map(s => s.text).join(' ').replace(/\s+/g, ' ').trim()`
    - Implement 15-second timeout using `Promise.race` with `AbortController` or `setTimeout`
    - Return proper HTTP status codes: 200 success, 400 bad request, 404 no captions, 500 unexpected
    - Include `Content-Type: application/json` header on all responses
    - Differentiate timeout errors from no-caption errors in the response message

    3. Create `vercel.json` to configure:
    - Edge Function routing for `/api/**`
    - SPA fallback: rewrite all non-API, non-asset routes to `/index.html`

    ```json
    {
      "rewrites": [
        { "source": "/api/(.*)", "destination": "/api/$1" },
        { "source": "/((?!api|assets).*)", "destination": "/index.html" }
      ]
    }
    ```
  </action>
  <verify>
    - `npm run build` succeeds (TypeScript compiles)
    - `api/transcripts.ts` exists with Edge Function config
    - `vercel.json` exists with rewrites
    - File exports default handler function and config object
  </verify>
  <done>
    Edge Function file exists at api/transcripts.ts with: videoId validation (400), caption extraction via youtube-caption-extractor (200), error handling for missing captions (404), 15s timeout, CORS headers. vercel.json configures routing.
  </done>
</task>

</tasks>

<verification>
- `api/transcripts.ts` exports default async handler and config with runtime: 'edge'
- Handler validates videoId, calls getSubtitles, joins text, returns JSON
- Error responses differentiate missing params, no captions, and timeouts
- `vercel.json` has rewrites for API routing and SPA fallback
- `npm run build` passes
</verification>

<success_criteria>
- Edge Function file created with correct Vercel conventions
- youtube-caption-extractor installed as dependency
- Proper error handling for all failure modes
- vercel.json configured for both API and SPA routing
</success_criteria>

<output>
After completion, create `.planning/phases/04-transcript-extraction/04-01-SUMMARY.md`
</output>
